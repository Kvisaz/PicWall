# PicWall
Приложение для просмотра картинок из интернета (тестовое задание)

## Что готово
- картинки берутся из  https://api.desktoppr.co/1/wallpapers
- картинки выводятся сеткой
- пагинация картинок в сетке
- при клике на элементе сетки открывается большое превью
- скроллинг большой картинки
- загрузка картинок в других потоках (используется пул ExecutorService)
- кэширование в файловой системе
- кэширование загрузки картинок в памяти
- отображение индикатора загрузки для больших картинок (используется обратная связь с UI через handler)
- базовая оптимизация под телефоны и планшеты, пропорция 1:1.5

## Архитектура
1. Сначала, на этапе запуска *App*, cоздаются **Presenter** и **ImageLoader**, подтягиваются строковые и некоторые числовые данные из ресурсов в *Constants*.java.
2. **Presenter** работает с сервером, подтягивает страницы и укладывает их в __пул__ - внутреннюю коллекцию из 3 страниц (число можно увеличить). При каждой успешной загрузке страницы бросает событие *PageLoadEvent*
3. **Сетевая часть** - простой суповой набор на базе *Retrofit 2*.  Класс __Client__ выполняет финальное преобразование в упрощенные модели (папка models) из исходных JSON-моделей (network/models).
4. __Интерфейс__ - построен из двух мета-классов __GridView__ и __PictureView__, которые представляют собой сетку картинок и просмотрщик большой картинки соответственно. Это контейнеры для обычных _View_-элементов Android, которым для работы нужно подать корневой View от Activity или фрагмента (тестировал и так, и так, легко перевтыкаются в оба варианта)
5. __Activity__ - главная, которая запускается всегда, и вспомогательная, которая запускается только на небольших экранах. 
6. __PictureView__ - вьюер большой картинки, подключается как фрагмент в главную или вспомогательную Activity. Содержит внутри ViewPager. Подробности ниже.
7. __GridView__ - сетка картинок. Построена на модифицированной разновидности RecyclerView, которая добавляет секции с заголовками страниц. 

## Логика работы
Интерфейсные модули - сетка и вьюер - обращаются к Presenter напрямую (внедрен в модули), чтобы получить следующую страницу. Если страницу заказывает сетка - вьюер никак не реагирует. Если страницу заказывает вьюер -  и подгружает при этом новую страницу с сервера, которой ещё нет в пуле страниц, то сетка получает обычное уведомление о загрузке следующей страницы от Presentera - и немного прокручивается вперед или назад.
 
 __Presenter__ сообщает о приходе новых данных через события EventBus. В принципе, следовало бы и обращение к нему сделать на таких же сообщениях, но я решил оставить прямые вызовы, чтобы не плодить лишний код (которого у меня и так много).  

__Presenter__ и __ImageLoader__ существуют все время. Оба используют пул потоков (на 1 поток у первого, и на несколько - у второго) для асинхронной загрузки данных с сервера и обработки картинок.

__ImageLoader__ получает через свой метод _ImageView_, которое надо заполнить, а также _ProgressBar_, если надо показать индикатор загрузки. Если вместо второго передать null, то загрузчик не используется. Для сообщения прогресса используется экземпляр Handler, который запускается в главном потоке при создании загрузчика.
 
__ImageLoader__ перебрасывает поток из интернет-соединения в поток записи в файл. После окончания копирования берутся размеры получившейся картинки, рассчитывается коэффициент уменьшения,  после чего из файла читается уменьшенный Bitmap. Коэффициент уменьшения зависит от максимальной ширины картинки, которая также передаётся основному методу _ImageLoader_
  
 Вообще, в _ImageLoader_ есть ещё над чем поработать, как и в _Presenter_ - это два интересных и нетривиальных класса, которые при умелой доводке можно сделать красивыми. 
   
Небольшое примечание: выяснилось что на Nook HD такой самопальный загрузчик работает значительно быстрее, чем Picasso (вероятно, особенность именно моей модели планшета, на других телефонах Picasso работает без тормозов). Но я был рад, что решил этот вопрос, а то он меня сильно беспокоил, когда я писал [читалку для Баша](https://github.com/Kvisaz/SimpleBashReader)

## PictureView - просмотрщик картинок
В основе лежит ViewPager, который был выбран за красоту анимации. Хотя RecyclerView, который я пробовал для этих целей раньше, потребляет куда меньше памяти. 

Схема такая - с помощью OnPictureViewerScroller отслеживается перемещение пейджера в крайние позиции, после чего через EventBus вызывается показ следующей картинки.
 
__PictureView__ хранит в себе ссылку на страницу, на которой находится выбранная картинка. Поэтому в пределах страницы он обрабатывает скроллинг самостоятельно, обращаясь к Presenter только если следующая и предыдущая картинка находятся за пределами страницы.

Пейджер построен на базе FragmentAdapter. Как выяснилось, именно у этого адаптера [наблюдается течь памяти при смене ориентации экрана](http://stackoverflow.com/questions/19393076/how-to-properly-handle-screen-rotation-with-a-viewpager-and-nested-fragments). Мне удалось немного её уменьшить за счёт фокуса, что картинка запрашивается не сразу, а при скроллинге на пустую страницу ViewPager. Но вообще придется либо переписать адаптер, как указано по ссылке, либо попробовать другие варианты.

Фрагменты пейджера создают свой облик на основе String url, который им передаётся. Если в url передать специальные строки, то будет показана кошечка (юзабилити-маркеры начала и конца глобального списка страниц). 





## Ограничения
- Android 4.0+ - выполнено (тестирую на планшете Nook HD+, 4.0.4, API 15)  
- Не использовать сторонние библиотеки загрузки картинок - выполнено. 

## Использованные библиотеки
- Retrofit 2
- Eventbus 3
- Dagger 2
- [sectioned-recyclerview](https://github.com/afollestad/sectioned-recyclerview) - для вывода информации о страницах галереи. Выглядит наглядно, но усложняет расчёты. Не включал в gradle, просто скопировал файл (он там один)

## Таймлог - 73 часа на данный момент
Учитываются чистые, "концентированные" часы, в которых шло собственно программирование.  

### среда 6 апреля - 4 часа
- Каркас-архитектура  -  2
- Иконка приложения - 0.5
- Сервер, модели данных, получение списка картинок - 1.5

### четверг 7 апреля - 6 часов
- Макет (сетка) - 1 + 0.5 + 1
- Рефакторинг под более абстрактные модели Picture, Page, чтобы было проще адаптировать к другим серверам и источникам картинок. - 0.5 
- Загрузчик картинок (загрузчик превью) - 3
  
### суббота 9 апреля - 3 часа
- загрузчик превью	-  3 часа.  Заработал. Разобрался с Looper и Handler, спасибо.

### воскресенье 10 апреля - 3 часа
- тестирование загрузчика на других телефонах (SDK23) - 1
- правка файлового кэша  - 2
> Отказ от внешнего хранилища. Поставил ограничение на макс число файлов и автоматическое удаление самых старых

### понедельник 11 апреля - 6 часов
1. Переписал загрузчик на Dagger  - 3 часа
> Обоснование: загрузчику нужен контекст, а он используется только в файловом кэше. Далее, я хочу использовать этот же загрузчик и в компоненте просмотра большой картинки - но исходная архитектура туториала предполагает создание экземпляра ImageLoader в компоненте. Dependency Injection позволит решить обе эти проблемы.

Итоги: 
Презентер больше не создаётся внутри Activity (недочёт моего предыдущего подхода к архитектуре).
ImageLoader теперь независимый синглтон, можно использовать в разных компонентах

2. Загрузка большой картинки - 3 часа

### вторник 12 апреля - 3 часа
- Дизайн индикатора + общий дизайн немного - 1 час
- Рефакторинг ImageLoader  - 2 часа

### среда 13 апреля - 5 часов
1. индикатор загрузки - 2 часа
> Вывод надписи над индикатором (универсальный класс ProgressIndicator). 
> Баг индикатора (выводился не полностью, причина - типичный int division)
2. пагинация Desktoprr - 3 часа

### четверг 14 апреля - 2 часа
- пагинация Desktoprr - 1.5
- окраска фона - 1  (пытался подобрать идеальную функцию для цвета текста, оставил простой выбор между черным и белым, см. ColorUtils.java)
- вывод страницы текущей  (заголовок разделителя?) - 0.5

### пятница 15 апреля - 2.5 часа
- пагинация Desktoprr - 2 часа

### суббота 16 апреля - 2.5  часа
- пагинация Desktoprr - 2.5 часа
- переход на секционированный RecycleView (инфо о страницах выводятся в сетке)
- шлифовка поведения при дозагрузке и удалении страниц для бесконечного скролла
- оптимизация памяти (удаление "хвостов" при прокрутке, чтобы не загружать в память все 4000 страниц)

### воскресенье 17 апреля - 6 часов
- свайп большой картинки - 6 часов
- решение на базе RecycledView (обычный, без секций)
- префетчинг соседей после загрузки картинки

### понедельник 18 апреля - 2 часа
- свайп большой картинки - 2 с утра
- выделение картинки в сетке при переходе 
- переходы между страницами, запрос новой страницы с сервера 
- баги, отладка 

### вторник 19 апреля - 7 часов
- переход большой картинки на ViewPager - 2
- улучшение Presenter - 3 часа
- отладка Grid под новый Presenter - 2 часа

### среда 20 апреля - 5 часов
- отладка большой картинки под Presenter - 2.5
- отладка OutOfMemory Error в загрузчике - 0.5 
- адаптация под телефоны / планшеты - 2

### четверг 21 апреля - 10 часов
- верстка под разные разрешения - 4
- попытка устранить течь памяти в ViewPager при повороте - 3
-- пока не удалась, либо на RecyclerView переходить, либо свой адаптер писать
- скроллинг страницы, баги, верстка - 3

### пятница 22 апреля, утро - 6 часов
- тестирование на разных эмуляторах
- оптимизация скроллинга ViewPager
- кошечка на секретной нулевой странице в ViewPager
- отчет

Сергей Токарев.
22 апреля 2016





